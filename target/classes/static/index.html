<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>扫描登录</title>
  <style>
    #qrCode {
      display: none;
      width: 270px;
      height: 270px;
      position: absolute;
      top: 50%;
      left: 50%;
      margin-left: -135px;
      margin-top: -135px;
      box-shadow: #999 0 2px 10px;
    }

    #contact {
      box-shadow: #999 0 2px 10px;
      width: 30%;
    }

    #session {
      box-shadow: #999 0 2px 10px;
      width: 30%;
    }

    #mp {
      box-shadow: #999 0 2px 10px;
      width: 30%;
    }

    #contact, #session, #mp {
      float: left;
      text-align: center;
    }

    p:hover {
      cursor: pointer;
      background-color: cornflowerblue;
    }
  </style>
</head>
<script src="jquery-3.3.1.min.js"></script>
<script>
  let uuid;

  /**
   * 开始执行
   */
  $(function () {
    //请求二维码
    $.get("/getQrCode", function (result) {
      uuid = result.uuid;
      if (uuid == null) {
        if (result.contact != null) {
          initData(result);
        } else {
          alert("稍后再试");
        }
      } else {
        $('#qrCode').toggle(1000);
        $('#qrCode').attr("src", result.qrCode);
        //刷新登录状态
        refreshStatus()
      }
    });
  });

  /**
   * 刷新登录状态
   */
  let repeat = true;

  function refreshStatus() {
    $.get("/getLoginStatus/" + uuid, function (result) {
      let code = result.code;
      switch (code) {
        case 200:
          repeat = false;
          $('#qrCode').toggle(2000);
          break;
        case 201:
          $('#qrCode').attr("src", result.userAvatar);
          break;
        case 408:
          console.log(result);
          break;
        default:
          alert(result);
          window.location.reload();
      }
      if (repeat) {
        setTimeout(refreshStatus, 5000);
      } else {
        init(result.ticket, result.uuid, result.scan);
      }
    });
  }

  /**
   * 初始化
   */
  function init(ticket, uuid, scan) {
    $.ajax({
      url: "/init",
      type: "GET",
      data: {ticket: ticket, uuid: uuid, scan: scan},
      success: function (result) {
        initData(result);
      },
      error: function (e) {
        console.log(e);
      }
    });
  }

  function initData(result) {
    console.log(result);
    //设置标题
    $('#hello').html(result.init.user.nickName);
    //设置好友列表
    let contactHtml = "<h2>好友列表</h2>";
    let memberList = result.contact.memberList;
    let contact;
    for (let i = 0; i < memberList.length; i++) {
      contact = memberList[i];
      if (contact.contactFlag == 3 && (contact.verifyFlag == 8 || contact.verifyFlag == 24)) {
        continue;
      }
      contactHtml += "<p>" + contact.nickName;
      if (contact.remarkName != null && contact.remarkName != "") {
        contactHtml += "(" + contact.remarkName + ")";
      }
      contactHtml += "</p>";
    }
    $('#contact').html(contactHtml);

    //设置公众号
    let mpHtml = "<h2>公众号文章</h2>";
    let mpList = result.init.mpsubscribeMsgList;
    let mp;
    for (let i = 0; i < mpList.length; i++) {
      mp = mpList[i];
      mpHtml += "<p>" + mp.nickName + "：</p>";
      let article;
      for (let j = 0; j < mp.mparticleList.length; j++) {
        article = mp.mparticleList[j];
        mpHtml += "<p>" + article.title + "：</p>";
      }
    }
    $('#mp').html(mpHtml);

    //设置会话
    let sessionHtml = "<h2>最近会话</h2>";
    let sessionList = result.init.contactList;
    let session;
    for (let i = 0; i < sessionList.length; i++) {
      session = sessionList[i];
      sessionHtml += "<p>" + session.nickName + "</p>";
    }
    $('#session').html(sessionHtml);
  }
</script>
<body>
<img id="qrCode" src="" alt="二维码">
<h1 id="hello"></h1>
<div id="session"></div>
<div id="mp"></div>
<div id="contact"></div>
</body>
</html>