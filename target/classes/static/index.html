<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>扫描登录</title>
  <style>
    #qrCode {
      display: none;
      width: 270px;
      height: 270px;
      position: absolute;
      top: 50%;
      left: 50%;
      margin-left: -135px;
      margin-top: -135px;
      box-shadow: #999 0 2px 10px;
    }

    #contact {
      box-shadow: #999 0 2px 10px;
      width: 30%;
    }

    #session {
      box-shadow: #999 0 2px 10px;
      width: 30%;
    }

    #mp {
      box-shadow: #999 0 2px 10px;
      width: 30%;
    }

    #contact, #session, #mp {
      float: left;
      text-align: center;
    }

    p:hover {
      cursor: pointer;
      background-color: cornflowerblue;
    }
  </style>
</head>
<script src="jquery-3.3.1.min.js"></script>
<script>
  let uuid;

  /**
   * 开始执行
   */
  $(function () {
    login();
  });

  /**
   * 判断是否登录
   */
  function login() {
    $.get("/isLogin", function (result) {
      if (result == null || result == "") {
        //未登录，获取二维码
        getQrCode();
      } else {
        //初始化
        init();
        //获取联系人
        initContact();
      }
    });
  }

  /**
   * 请求二维码
   */
  function getQrCode() {
    $.get("/getQrCode", function (result) {
      uuid = result.uuid;
      if (uuid == null) {
        alert("稍后再试");
      } else {
        //设置二维码
        $('#qrCode').attr("src", result.qrCode);
        $('#qrCode').toggle(1000);

        //刷新登录状态
        refreshStatus()
      }
    });
  }

  /**
   * 刷新登录状态
   */
  let repeat = true;

  function refreshStatus() {
    let url = "/getLoginStatus/" + uuid;
    $.get(url, function (result) {
      let code = result.code;
      switch (code) {
        case 200:
          //登录成功，停止刷新
          repeat = false;
          $('#qrCode').toggle(2000);
          break;
        case 201:
          //扫描成功，设置头像
          $('#qrCode').attr("src", result.userAvatar);
          break;
        case 408:
          break;
        default:
          alert(JSON.stringify(result));
          window.location.reload();
      }
      if (repeat) {
        //继续刷新
        refreshStatus();
      } else {
        //初始化
        init();
        //获取联系人
        initContact();
      }
    });
  }

  /**
   * 初始化
   */
  function init() {
    $.ajax({
      url: "/init",
      type: "GET",
      success: function (result) {
        console.log(result);
        let baseResponse = result.baseResponse;
        if (baseResponse.ret != 0) {
          //请求数据错误，重新登录
          alert(JSON.stringify(baseResponse));
          window.location.reload();
        }
        initData(result);
        //刷新消息
        refreshMsg(result.syncKey);
      },
      error: function (e) {
        console.log(e);
      }
    });
  }

  /**
   * 初始化通讯录
   */
  function initContact() {
    $.ajax({
      url: "/getContact",
      type: "GET",
      success: function (result) {
        console.log(result);
        let baseResponse = result.baseResponse;
        if (baseResponse.ret != 0) {
          //请求数据错误，重新登录
          alert(JSON.stringify(baseResponse));
          window.location.reload();
        }
        initContactData(result);
      },
      error: function (e) {
        console.log(e);
      }
    });
  }

  /**
   * 初始化数据
   */
  function initData(result) {
    //设置标题
    $('#hello').html(result.user.nickName);

    //设置公众号
    let mpHtml = "<h2>公众号文章</h2>";
    let mpList = result.mpsubscribeMsgList;
    let mp;
    for (let i = 0; i < mpList.length; i++) {
      mp = mpList[i];
      mpHtml += "<p>" + mp.nickName + "：</p>";
      let article;
      for (let j = 0; j < mp.mparticleList.length; j++) {
        article = mp.mparticleList[j];
        mpHtml += "<p>" + article.title + "：</p>";
      }
    }
    $('#mp').html(mpHtml);

    //设置会话
    let sessionHtml = "<h2>最近会话</h2>";
    let sessionList = result.contactList;
    let session;
    for (let i = 0; i < sessionList.length; i++) {
      session = sessionList[i];
      sessionHtml += "<p>" + session.nickName;
      if (session.remarkName != null && session.remarkName != "") {
        sessionHtml += "(" + session.remarkName + ")";
      }
      sessionHtml += "</p>";
    }
    $('#session').html(sessionHtml);
  }

  /**
   * 初始化通讯录数据
   */
  function initContactData(result) {
    //设置好友列表
    let contactHtml = "<h2>好友列表(" + result.memberCount + ")</h2>";
    let contactList = result.memberList;
    let contact;
    for (let i = 0; i < contactList.length; i++) {
      contact = contactList[i];
      contactHtml += "<p>" + contact.nickName;
      if (contact.remarkName != null && contact.remarkName != "") {
        contactHtml += "(" + contact.remarkName + ")";
      }
      contactHtml += "</p>";
    }
    $('#contact').html(contactHtml);
  }

  /**
   * 刷新消息
   */
  function refreshMsg(syncList) {
    $.ajax({
      url: "/refresh",
      type: "POST",
      data: JSON.stringify(syncList),
      contentType:"application/json;charset-UTF-8",
      success: function (result) {
        console.log(result);
        let baseResponse = result.baseResponse;
        if (baseResponse.ret != 0) {
          //请求数据错误，重新登录
          alert(JSON.stringify(baseResponse));
          window.location.reload();
        }
        //有新消息
        if (result.addMsgCount > 0) {
          let html = $('#session').html();
          let addMsgList = result.addMsgList;
          for (let item in addMsgList) {
            html += "(" + addMsgList[item].content + ")";
            html += "(" + addMsgList[item].msgType + ")";
          }
          $('#session').html(html);
        }

        //不断刷新
        setTimeout(function () {
          refreshMsg(result.syncKey);
        },5000);
      },
      error: function (e) {
        console.log(e);
      }
    });
  }

</script>
<body>
<img id="qrCode" src="" alt="二维码">
<h1 id="hello"></h1>
<div id="session"></div>
<div id="mp"></div>
<div id="contact"></div>
</body>
</html>