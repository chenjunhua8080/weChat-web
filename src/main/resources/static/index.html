<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>扫描登录</title>
  <style>
    #qrCode {
      display: block;
      width: 270px;
      height: 270px;
      position: absolute;
      top: 50%;
      left: 50%;
      margin-left: -135px;
      margin-top: -135px;
      box-shadow: #999 0 2px 10px;
    }
  </style>
</head>
<script src="jquery-3.3.1.min.js"></script>
<script>
  let uuid;

  /**
   * 开始执行
   */
  $(function () {
    //请求二维码
    $.get("/getQrCode", function (result) {
      uuid = result.uuid;
      if (uuid == null) {
        alert("稍后再试");
      } else {
        $('#qrCode').attr("src", result.qrCode);
        //刷新登录状态
        refreshStatus()
      }
    });
  });

  /**
   * 刷新登录状态
   */
  let repeat = true;

  function refreshStatus() {
    $.get("/getLoginStatus/" + uuid, function (result) {
      var code = result.code;
      switch (code) {
        case 200:
          repeat = false;
          break;
        case 201:
          $('#qrCode').attr("src", result.userAvatar);
          break;
        case 408:
          console.log(result);
          break;
        default:
          alert(result);
          window.location.reload();
      }
      if (repeat) {
        setTimeout(refreshStatus, 5000);
      } else {
        init(result.ticket, result.uuid, result.scan);
      }
    });
  }

  /**
   * 初始化
   */
  function init(ticket, uuid, scan) {
    $.ajax({
      url: "/init",
      type: "GET",
      data: {ticket: ticket, uuid: uuid, scan: scan},
      success: function (result) {
        console.log(result);
        $('#content').text(result.user);
      },
      error: function (e) {
        console.log(e);
      }
    });
  }
</script>
<body>
<img id="qrCode" src="" alt="二维码">
<div id="content"></div>
</body>
</html>